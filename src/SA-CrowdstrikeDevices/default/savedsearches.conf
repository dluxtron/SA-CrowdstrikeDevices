# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[Crowdstrike Devices Lookup - Gen]
disabled = false
cron_schedule = 19 * * * *
description = populates kvstore lookup: crowdstrike_devices
dispatch.earliest_time = -61m@m
dispatch.latest_time = -1m@m
enableSched = 1
schedule_window = auto
search = `sa_crowdstrike_index` sourcetype="crowdstrike:device:json" \
| dedup falcon_device.device_id falcon_device.mac_address \
| eval \
    category=mvjoin(mvsort(mvappend( \
    lower(replace('falcon_device.product_type_desc', " ", "_")), \
    lower(replace('falcon_device.ou{}', " ", "_")) \
    )), "|"), \
    nt_host=lower('falcon_device.hostname'), \
    dns=lower(nt_host.".".'falcon_device.machine_domain'), \
    external_ip='falcon_device.external_ip', \
    mac=lower(replace('falcon_device.mac_address', "-", ":")), \
    operatingSystem='falcon_device.platform_name', \
    operatingSystemVersion='falcon_device.os_version', \
    _key='falcon_device.device_id' \
| stats values(mac) as mac, values(falcon_device.local_ip) as ip, values(dns) as dns values(category) as category values(nt_host) as nt_host values(external_ip) as external_ip values(operatingSystem) as operatingSystem, values(operatingSystemVersion) as operatingSystemVersion by _key  \
| iplocation external_ip  \
| rename lon as long, City as city, Country as country  \
| eval  \
    mac=mvjoin(mac, "|"), \
    ip=mvjoin(ip, "|"), \
    dns=mvjoin(dns, "|"), \
    _last_seen=now() \
| table _key,_last_seen,ip,mac,nt_host,dns,lat,long,city,country,category,external_ip, operatingSystem, operatingSystemVersion \
| outputlookup key_field=_key crowdstrike_devices \
| stats count

[Crowdstrike Devices Lookup - Cleanup]
disabled = false
cron_schedule = 29 * * * *
description = removes old entries from kvstore lookup: crowdstrike_devices
dispatch.earliest_time = -1s
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = | inputlookup crowdstrike_devices \
| where _last_seen>relative_time(now(), `sa_crowdstrike_retention`) \
| outputlookup crowdstrike_devices \
| stats count
